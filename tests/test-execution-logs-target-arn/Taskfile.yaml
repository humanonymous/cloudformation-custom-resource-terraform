version: "3"

set:
  - errexit
  - nounset
  - pipefail

includes:
  lib:
    taskfile: ../lib.yaml

tasks:
  run-test:
    desc: Tests that the logs are successfully passed to a custom log group when the ExecutionLogsTargetArn property is present
    cmds:
      - echo "--- --- --- --- ---"
      - defer: { task: cleanup }
      - task: set-up
      - task: create

  set-up:
    cmds:
      - task: lib:set-up:empty

  assert-custom-log-group-logs-present:
    cmds:
      - |
        echo "üß™ Running assert-custom-log-group-logs-present to check that terraform logs are present in the custom log group .."
        OUTPUT=$(aws logs filter-log-events --log-group-name "dev-test-log-group-for-terraform" --filter-pattern '"Initializing the backend"')
        if [ $? -ne 0 ] || echo "$OUTPUT" | grep -q '"events": \[\]'; then
          echo "‚ùå No matching log events were found or the AWS CLI command failed."
        else
          echo "‚úÖ Matching log events were found."
        fi


  create:
    desc: "Set up resources and deploy {{.TEST_NAME}} stack for CREATE phase"
    cmds:
      - echo "üöÄ Running CREATE phase for stack \"{{.TESTS_SOFTWARE_NAME}}-tests-{{.TEST_NAME}}\""
      - task: lib:deploy-stack
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
          TEMPLATE_FILE: templates/Create.yaml
      - task: lib:assert-stack-status
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
          EXPECTED_STATUS: CREATE_COMPLETE
      - task: lib:assert-resource-present
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
          RESOURCE_ID: CustomTerraformExecutionLogsTargetArn
      - task: assert-custom-log-group-logs-present
      - task: lib:assert-output-value
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
          OUTPUT_KEY: Result
          EXPECTED_VALUE: "success"

  cleanup:
    desc: "Clean up the {{.TEST_NAME}} stack after tests"
    cmds:
      - task: lib:cleanup
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
