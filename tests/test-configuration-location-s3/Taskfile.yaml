version: "3"

set:
  - errexit
  - nounset
  - pipefail

includes:
  lib:
    taskfile: ../lib.yaml

tasks:
  run-test:
    desc: Tests that the Terraform configuration can be obtained from a S3 bucket
    cmds:
      - echo "--- --- --- --- ---"
      - defer: { task: cleanup }
      - task: set-up
      - task: create

  set-up:
    cmds:
      - task: lib:set-up:s3:test-resources
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
          RESOURCES_DIR: "./resources"

  create:
    desc: "Set up resources and deploy {{.TEST_NAME}} stack for CREATE phase"
    cmds:
      - echo "ðŸš€ Running CREATE phase for stack \"{{.TESTS_SOFTWARE_NAME}}-tests-{{.TEST_NAME}}\""
      - task: lib:deploy-stack
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
          TEMPLATE_FILE: templates/Create.yaml
          PARAMETER_OVERRIDES: "S3Bucket={{.TESTS_S3_PRIVATE_BUCKET}} S3Prefix={{.TESTS_S3_PRIVATE_PREFIX}}"
      - task: lib:assert-stack-status
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
          EXPECTED_STATUS: CREATE_COMPLETE
      - task: lib:assert-resource-present
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
          RESOURCE_ID: CustomTerraformConfigurationLocationS3
      - task: lib:assert-output-value
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
          OUTPUT_KEY: Result
          EXPECTED_VALUE: "success"

  cleanup:
    desc: "Clean up the {{.TEST_NAME}} stack after tests"
    cmds:
      - task: lib:cleanup
        vars:
          TEST_NAME: "{{.TEST_NAME}}"
